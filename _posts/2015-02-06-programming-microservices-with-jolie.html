---
layout: post
title: 'Programming Microservices with Jolie - Part 1: Data formats, Proxies, and
  Workflows.'
date: '2015-02-06T15:44:00.001+01:00'
author: Fabrizio Montesi
tags:
- tutorials
- microservices
- jolie
modified_time: '2015-02-10T13:40:29.651+01:00'
blogger_id: tag:blogger.com,1999:blog-3856624862131672592.post-3838881533395778163
blogger_orig_url: http://fmontesi.blogspot.com/2015/02/programming-microservices-with-jolie.html
---

In&nbsp;<a href="http://en.wikipedia.org/wiki/Microservices" target="_blank">Microservice</a>&nbsp;architectures, software components are built as reusable and scalable services that interact with each other. While this introduces many advantages, it also brings all the issues of distributed computing to the internals of software applications and developers <a href="http://martinfowler.com/articles/microservices.html" target="_blank">need to be careful about this</a>. Luckily, we are standing on the shoulders of all the knowledge that we accumulated by using <a href="http://en.wikipedia.org/wiki/Service-oriented_architecture" target="_blank">Service-oriented Architectures</a>&nbsp;(SOAs), so we are more aware of these issues and we have more technologies and methodologies to deal with them. Microservices could (and I believe they will) fly after all, in one form or the other, and we at the <a href="http://www.jolie-lang.org/" target="_blank">Jolie</a> team are surely not the only ones sharing this <a href="http://www.infoworld.com/article/2864453/application-development/why-2015-will-be-the-year-of-microservices.html" target="_blank">optimism</a>.<br /><br />But like SOAs were, Microservices are also at risk of exposing programmers to too much complexity to deal with when they take their first steps in this world. And we are at risk again of making arbitrary technology choices that we may regret later, just like <a href="http://en.wikipedia.org/wiki/SOAP" target="_blank">SOAP</a> was in many cases.<br /><br />In developing <a href="http://www.jolie-lang.org/" target="_blank">Jolie</a>, a microservice-oriented programming language, we are trying to make microservice programming simple and productive. A major challenge in this is <b>how we can map design ideas for a microservice architecture to code as fast as possible</b>, without committing to specific implementation details on communications and service deployment/distribution.<br /><br />The problem of focusing on design issues and not getting locked inside of interoperability problems is particularly dear to me. Jolie helps in this, e.g., by abstracting application logic from the underlying data formats that you will use for communications.<br /><br />Another problem that is dear to the team in general and I will talk about below is that of making composition of microservices easy. This does not simply mean composition of the operations offered by microservices, but also dealing with how we can deploy new systems based on previously developed systems.<br /><br />But talk is cheap. Let's do code and see an example.<br /><br /><br /><h2>Get Jolie</h2>You don't need to have Jolie installed to read this article, but if you want to try what I will show, <a href="http://jolie-lang.org/downloads.html" target="_blank">go install Jolie</a>.<br />Ready? Let's proceed.<br /><br /><br /><h2>A calculator microservice</h2>We are going to program a little toy calculator microservice for making additions. Feeling lazy? Download the code <a href="http://fabriziomontesi.com/files/blog/jolie_microservices_part1.zip" target="_blank">here</a>.<br />Open a file and call it <span style="font-family: Courier New, Courier, monospace;">calculator.ol</span><span style="font-family: inherit;">.</span><br /><span style="font-family: inherit;">Then we write:</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: Courier New, Courier, monospace;">include "calculator.iol"</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">execution { concurrent }</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">inputPort CalcInput {</span><br /><span style="font-family: Courier New, Courier, monospace;">Location: "socket://localhost:8000"</span><br /><span style="font-family: Courier New, Courier, monospace;">Protocol: sodep</span><br /><span style="font-family: Courier New, Courier, monospace;">Interfaces: CalcIface</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">main</span><br /><span style="font-family: Courier New, Courier, monospace;">{</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>sum( req )( resp ) {</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>resp = req.x + req.y</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>}</span><br /><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span>Above, we are telling Jolie that this microservice is concurrent, i.e., each request is handled in parallel by a lightweight process (Jolie processes are implemented as threads with a local state).<br />The input port CalcInput states that the service can be accessed using TCP/IP sockets on port 8000, using the <a href="http://docs.jolie-lang.org/#!documentation/protocols/sodep.html" target="_blank">SODEP</a> protocol. CalcIface is the exposed interface, which we define in &nbsp;the included file <span style="font-family: Courier New, Courier, monospace;">calculator.iol</span><span style="font-family: inherit;">:</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: Courier New, Courier, monospace;">type SumT:void {</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>.x:int</span><br /><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>.y:int</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">interface CalcIface {</span><br /><span style="font-family: Courier New, Courier, monospace;">RequestResponse: s</span><span style="font-family: 'Courier New', Courier, monospace;">um( SumT )( int )</span><br /><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><div><br /></div><div><span style="font-family: inherit;">CalcIface is an interface with only one Request-Response operation called sum, which receives a tree with two nodes (x and y, both integers) and returns an integer.</span></div><div>The sum operation is implemented in the main procedure of the calculator microservice: it simply receives the message on variable req and replies with the sum of the two subnodes x and y to the invoker.</div><div><br /></div><div><br /></div><h2><span style="font-family: inherit;">Using the calculator</span></h2><div><span style="font-family: inherit;">Using the calculator service from Jolie is easy. We create a </span><span style="font-family: Courier New, Courier, monospace;">client.ol </span><span style="font-family: inherit;">program, include the interface and off we go:</span></div><div><span style="font-family: inherit;"><br /></span></div><div><div><span style="font-family: Courier New, Courier, monospace;">include "calculator.iol"</span></div><div><span style="font-family: Courier New, Courier, monospace;">include "console.iol"</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">outputPort Calculator {</span></div><div><span style="font-family: Courier New, Courier, monospace;">Location: "socket://localhost:8000"</span></div><div><span style="font-family: Courier New, Courier, monospace;">Protocol: sodep</span></div><div><span style="font-family: Courier New, Courier, monospace;">Interfaces: CalcIface</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">main</span></div><div><span style="font-family: Courier New, Courier, monospace;">{</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>with( req ) {</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>.x = 3;</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>.y = 2</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>};</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>sum@Calculator( req )( resp );</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>println@Console( resp )()</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div><div style="font-family: inherit;"><br /></div></div><div><span style="font-family: inherit;">Running this client program will reach the calculator service and print the number 5 on screen. SODEP is a binary protocol, so you don't need to worry about overhead as much as you have to in, e.g., SOAP.</span></div><div><span style="font-family: inherit;"><br /></span></div><div>The attentive reader may have noticed that in our client code we are calling the println operation of the Console service, just like we are calling the sum operation of calculator. That's right, even our Console library is a microservice that you can relocate as you like.</div><div><span style="font-family: inherit;"><br /></span></div><h2><span style="font-family: inherit;">OK, but what if the rest of my system is not in Jolie?</span></h2><div><span style="font-family: inherit;">Jolie is interoperable with many other technologies, both server- and client-side. Let's see what happens if our client is not written in Jolie and does not support SODEP. Let's say instead that it's a web browser and that it consequently uses HTTP.</span></div><div>Take the calculator program again and add the following before the main procedure:</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">inputPort CalcWebInput {</span><br /><span style="font-family: Courier New, Courier, monospace;">Location: "socket://localhost:8080"</span><br /><span style="font-family: Courier New, Courier, monospace;">Protocol: http</span><br /><span style="font-family: Courier New, Courier, monospace;">Interfaces: CalcIface</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: inherit;">Et voil</span>à, now calculator is not only exposed on TCP port 8000 with SODEP but <b>also</b> on TCP port 8080 with the HTTP protocol. Run calculator and you can now point your browser to:<br /><br /><div style="text-align: center;"><a href="http://localhost:8080/sum?x=3&amp;y=5" target="_blank">http://localhost:8080/sum?x=3&amp;y=5</a></div><br />You will see calculator crunching the numbers and reply with:<br /><br /><div style="text-align: center;"><span style="font-family: Courier New, Courier, monospace;"><span class="html-tag" style="font-size: 14px;">&lt;sumResponse&gt;</span><span class="text" style="font-size: 14px;">8</span><span class="html-tag" style="font-size: 14px;">&lt;/sumResponse&gt;</span></span></div><span style="font-family: Courier New, Courier, monospace;"><span class="html-tag" style="font-size: 14px;"><br /></span></span>You can use many other protocols (HTTP/JSON, SOAP, local memory, ...) and communication mediums (Bluetooth, UNIX sockets, ...), depending on your needs. See <a href="http://docs.jolie-lang.org/#!documentation/protocols/introduction.html" target="_blank">here</a>.<br /><br /><br /><h2>What if I cannot change the code of my microservices?</h2></div><div><span style="font-family: inherit;">If your calculator is a black box that you cannot or do not want to touch, then you cannot just edit its code to add an HTTP input port. This is the typical case in which you would like to compositionally evolve your system without touching what has already been deployed.</span></div><div><span style="font-family: inherit;"><br /></span></div><div>The standard solution is to use a proxy. In our example, we wish to make a proxy that enables web browsers to communicate with the calculator service:</div><div><br /></div><div style="text-align: center;">Web browser <-> Proxy <-> Calculator<!-----><!-----><!-----><!-----></-></-></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Proxies (and variants) are very useful in general as intermediate glue components in service systems, but managing them may require you getting to know yet another technology. In Jolie, instead, proxies are powered by a native language primitive for forwarding messages and integrate well with our communication ports, so you can take advantage of the data abstraction layer provided by Jolie.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Open a file <span style="font-family: Courier New, Courier, monospace;">proxy.ol</span><span style="font-family: inherit;">&nbsp;and write:</span></div><div style="text-align: left;"><span style="font-family: inherit;"><br /></span></div><div style="text-align: left;"><div><span style="font-family: Courier New, Courier, monospace;">include "calculator.iol"</span></div><div><span style="font-family: Courier New, Courier, monospace;">include "console.iol"</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">execution { concurrent }</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">outputPort Calculator {</span></div><div><span style="font-family: Courier New, Courier, monospace;">Location: "socket://localhost:8000"</span></div><div><span style="font-family: Courier New, Courier, monospace;">Protocol: sodep</span></div><div><span style="font-family: Courier New, Courier, monospace;">Interfaces: CalcIface</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">inputPort ProxyInput {</span></div><div><span style="font-family: Courier New, Courier, monospace;">Location: "socket://localhost:9000"</span></div><div><span style="font-family: Courier New, Courier, monospace;">Protocol: http</span></div><div><span style="font-family: Courier New, Courier, monospace;">Aggregates: Calculator</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">main</span></div><div><span style="font-family: Courier New, Courier, monospace;">{</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>in()</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: inherit;">The important part here is that we have an input port on TCP port 9000 that <a href="http://docs.jolie-lang.org/#!documentation/architectural_composition/aggregation.html" target="_blank">aggregates</a> the output port towards the Calculator. This means that all messages on port ProxyInput for an operation provided by Calculator will be forwarded to that service. So now we have our proxy and we can navigate to:</span></div></div><div style="text-align: left;"><span style="font-family: inherit;"><br /></span></div><div style="text-align: center;"><a href="http://localhost:9000/sum?x=3&amp;y=5">http://localhost:9000/sum?x=3&amp;y=5</a></div><div style="text-align: center;"><br /></div><div style="text-align: left;">The proxy service will now receive your HTTP message on port ProxyInput, see that it is for the sum operation of calculator. The message is therefore converted to the SODEP format, as specified by the output port towards the calculator. The response from calculator will finally be converted again from SODEP to HTTP and sent to the initial client.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Aggregation is really useful. You can also add hooks (called <a href="http://docs.jolie-lang.org/#!documentation/architectural_composition/couriers.html" target="_blank">couriers</a>) for intercepting messages and, e.g, log operations or check for authentication credentials.</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><h2></h2><h2>Workflows</h2><div>Alright, now we have our toy microservice system. Let's say that after a while, you want to add the requirement that a user must log in before calling the sum operation on the calculator. This is a workflow, the magic keyword being <b>before</b>&nbsp;in the previous sentence. Jolie inherits native workflow primitives from business process languages (e.g., <a href="http://en.wikipedia.org/wiki/Business_Process_Execution_Language" target="_blank">BPEL</a>), making handling flows of communications among services a breeze!</div><div><br /></div><div>Open <span style="font-family: Courier New, Courier, monospace;">calculator.ol</span><span style="font-family: inherit;">&nbsp;and change the main definition as follows:</span></div><div><span style="font-family: inherit;"><br /></span></div><div><div><span style="font-family: Courier New, Courier, monospace;">cset {</span></div><div><span style="font-family: Courier New, Courier, monospace;">sid : SumT.sid</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">main</span></div><div><span style="font-family: Courier New, Courier, monospace;">{</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>login( creds )( csets.sid ) {</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>if ( creds.pwd != "jolie" ) {</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">   </span>throw( InvalidPwd, "The password is jolie" )</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>};</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>csets.sid = new</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>};</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>sum( req )( resp ) {</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;">  </span>resp = req.x + req.y</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>}</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: inherit;">The cset block above declares a session identifier sid, which we will use to track invocations coming from a same client (that's a <a href="http://docs.jolie-lang.org/#!documentation/basics/sessions.html" target="_blank">correlation set</a>). We also introduced a new operation, login, which simply checks if the password sent by the client is jolie and otherwise throws a fault to the invoker. Observe now that we use the semicolon operator to tell Jolie that sum becomes available only after login has successfully completed.</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">This is a fundamental difference with respect to, say, object-oriented computing, where if you want to enforce order in how different methods are called, you have to implement it yourself with bookkeeping variables and concurrent lock mechanisms. Here instead, you just write a semicolon.</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">We also need to update the interface of the calculator, in </span><span style="font-family: Courier New, Courier, monospace;">calculator.iol</span><span style="font-family: inherit;">, to account for our modifications:</span></div><div><span style="font-family: inherit;"><br /></span></div><div><div><span style="font-family: Courier New, Courier, monospace;">type SumT:void {</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>.x:int</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>.y:int</span></div><div><span class="Apple-tab-span" style="white-space: pre;"><span style="font-family: Courier New, Courier, monospace;"> </span></span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>.sid:string</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">type LoginT:void {</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>.pwd:string</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">interface CalcIface {</span></div><div><span style="font-family: Courier New, Courier, monospace;">RequestResponse:</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>login( LoginT )( string ) throws InvalidPwd( string ),</span></div><div><span style="font-family: Courier New, Courier, monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>sum( SumT )( int )</span></div><div><span style="font-family: Courier New, Courier, monospace;">}</span></div><div style="font-family: inherit;"><br /></div></div><div><span style="font-family: inherit;">We are done! No need to update the code of the proxy, as the aggregation primitive is parametric on the interface and the protocols used by the aggregated services. Jolie will do that lifting for us. So now we can browse to:&nbsp;</span></div><div><span style="font-family: inherit;"><br /></span></div><div style="text-align: center;"><a href="http://localhost:9000/login?pwd=jolie">http://localhost:9000/login?pwd=jolie</a></div><div><span style="font-family: inherit;"><br /></span></div><div>You will get a random session identifier. I got:</div><div><br /></div><div style="text-align: center;"><span class="html-tag" style="font-family: monospace; font-size: 14px;">&lt;loginResponse&gt;</span><span class="text" style="font-family: monospace; font-size: 14px;">193e6a7a-895c-4ff6-b32a-5bbab0eea7f3</span><span class="html-tag" style="font-family: monospace; font-size: 14px;">&lt;/loginResponse</span><span style="font-family: monospace; font-size: 14px;">&gt;</span></div><div><span style="font-family: inherit;"><br /></span></div><div><span style="font-family: inherit;">So now I can go to (remember to replace sid with what you got in the previous call if you try this yourself):</span></div><div><span style="font-family: inherit;"><br /></span></div><div style="text-align: center;"><a href="http://localhost:9000/sum?x=3&amp;y=5&amp;sid=193e6a7a-895c-4ff6-b32a-5bbab0eea7f3">http://localhost:9000/sum?x=3&amp;y=5&amp;sid=193e6a7a-895c-4ff6-b32a-5bbab0eea7f3</a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">And receive my good old 8 as result.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Have a look at the Jolie documentation if you are interested in using cookies and theming your responses with nice HTML. You can put that in a separate microservice, to keep calculator clean!</div><div style="text-align: left;"><br /></div><h2 style="text-align: left;">Conclusions</h2><div>This is just the tip of the iceberg of what you may have to do with microservices and what Jolie can do for you.</div><div><br /></div><div>But we can already see some of the underlying concepts that Jolie is based on:</div><div><br /></div><div><ul><li>You should not commit to any particular communication technology. Microservices are born to be lean and reusable, and should be kept decoupled from the implementation details of how data is exchanged.</li><li>Building proxies and <a href="http://docs.jolie-lang.org/#!documentation/architectural_composition/introduction.html" target="_blank">other kinds of architectural composers</a>&nbsp;is very handy in microservice architectures just like it is in any other distributed system. However, with microservices you can end up having a lot of them. Jolie helps in creating and managing these composers by making them programmable with native primitives that make it clear what is happening.</li><li>Workflows can help in making the structure of communications followed by a service explicit. They should be easy to write and Jolie strives in doing so. See <a href="http://docs.jolie-lang.org/#!documentation/basics/composing_statements.html" target="_blank">here</a> for our other workflow primitives.</li></ul><div><br /></div></div><div><br /></div><div>Stay tuned for the next chapters. :-)</div><div><br /></div><div>Meanwhile, you may want to have a look at some more material <a href="http://docs.jolie-lang.org/" target="_blank">here</a> and&nbsp;<a href="http://fabriziomontesi.com/teaching/imds-f2014/index.html" target="_blank">here</a>.</div></div>